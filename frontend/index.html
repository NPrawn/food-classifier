<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <title>음식 이미지 분류 서비스</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            * {
                box-sizing: border-box;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                    system-ui, sans-serif;
            }
            body {
                margin: 0;
                padding: 0;
                min-height: 100vh;
                background: #f3f4f6;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .wrapper {
                width: 100%;
                max-width: 900px;
                padding: 24px 16px;
            }
            .card {
                background: #ffffff;
                border-radius: 14px;
                box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
                padding: 20px 22px 22px;
            }
            .card-header {
                margin-bottom: 16px;
            }
            .card-title {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
                color: #111827;
            }
            .card-subtitle {
                margin: 4px 0 0;
                font-size: 13px;
                color: #6b7280;
            }

            .grid {
                display: grid;
                grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
                gap: 20px;
            }

            /* 업로드 영역 */
            .upload-box {
                border-radius: 10px;
                border: 1px solid #d1d5db;
                padding: 16px;
                background: #f9fafb;
            }
            .upload-label {
                font-size: 13px;
                font-weight: 500;
                margin-bottom: 8px;
                color: #374151;
            }
            .upload-area {
                border-radius: 8px;
                border: 1px dashed #d1d5db;
                padding: 18px 14px;
                text-align: center;
                cursor: pointer;
                background: #ffffff;
                transition: border-color 0.15s ease, background-color 0.15s ease;
            }
            .upload-area.hover {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            .upload-main {
                font-size: 13px;
                margin-bottom: 4px;
                color: #111827;
            }
            .upload-sub {
                font-size: 12px;
                color: #9ca3af;
            }
            #fileInput {
                display: none;
            }

            .preview-wrapper {
                margin-top: 14px;
                display: flex;
                gap: 12px;
                align-items: flex-start;
                flex-wrap: wrap;
            }
            .preview-image {
                width: 170px;
                height: 170px;
                border-radius: 10px;
                object-fit: cover;
                background: #e5e7eb;
                border: 1px solid #e5e7eb;
            }
            .preview-info {
                font-size: 12px;
                color: #6b7280;
                line-height: 1.5;
            }
            .preview-info b {
                color: #374151;
            }

            .buttons {
                margin-top: 14px;
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            button {
                border-radius: 999px;
                border: none;
                padding: 8px 14px;
                font-size: 13px;
                cursor: pointer;
                transition: background-color 0.15s ease, box-shadow 0.15s ease,
                    transform 0.08s ease;
            }
            .btn-primary {
                background-color: #2563eb;
                color: #ffffff;
                box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
            }
            .btn-primary:hover {
                background-color: #1d4ed8;
                transform: translateY(-1px);
                box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
            }
            .btn-primary:disabled {
                background-color: #9ca3af;
                box-shadow: none;
                cursor: default;
                transform: none;
            }
            .btn-secondary {
                background-color: #e5e7eb;
                color: #111827;
            }
            .btn-secondary:hover {
                background-color: #d1d5db;
            }

            .status {
                margin-top: 10px;
                font-size: 12px;
                color: #6b7280;
                min-height: 18px;
            }
            .status.error {
                color: #b91c1c;
            }
            .status.success {
                color: #15803d;
            }

            /* 결과 영역 */
            .result-box {
                border-radius: 10px;
                border: 1px solid #e5e7eb;
                padding: 14px 14px 12px;
                background: #f9fafb;
                font-size: 13px;
                color: #374151;
                max-height: 520px;
                overflow-y: auto;
            }
            .result-empty {
                font-size: 12px;
                color: #9ca3af;
                font-style: italic;
            }

            .results-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .result-card {
                background: #ffffff;
                border-radius: 10px;
                border: 1px solid #e5e7eb;
                padding: 10px 10px 10px;
                display: grid;
                grid-template-columns: 80px minmax(0, 1fr);
                gap: 10px;
            }
            .result-card-thumb {
                width: 80px;
                height: 80px;
                border-radius: 8px;
                object-fit: cover;
                background: #e5e7eb;
                border: 1px solid #e5e7eb;
            }
            .result-main {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .result-row {
                margin-top: 2px;
            }
            .result-label {
                font-weight: 500;
                margin-right: 4px;
                color: #4b5563;
                font-size: 12px;
            }
            .food-name {
                font-size: 14px;
                font-weight: 600;
                color: #111827;
            }
            .food-name-en {
                font-size: 11px;
                color: #6b7280;
                margin-left: 4px;
            }
            .confidence {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                font-size: 11px;
                padding: 2px 8px;
                border-radius: 999px;
                margin-left: 6px;
                background: #e5e7eb;
                color: #374151;
            }
            .conf-dot {
                width: 6px;
                height: 6px;
                border-radius: 999px;
                background: #22c55e;
            }
            .conf-mid {
                background: #facc15;
            }
            .conf-low {
                background: #f97316;
            }

            .prob-text {
                font-size: 12px;
                color: #4b5563;
            }
            .prob-bar-wrap {
                margin-top: 3px;
                background: #e5e7eb;
                border-radius: 999px;
                overflow: hidden;
                height: 6px;
            }
            .prob-bar {
                height: 100%;
                width: 0%;
                background: linear-gradient(90deg, #22c55e, #f97316);
                transition: width 0.25s ease;
            }

            .pill-group {
                margin-top: 4px;
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
            }
            .pill {
                font-size: 11px;
                padding: 3px 8px;
                border-radius: 999px;
                background: #e5e7eb;
                color: #374151;
            }
            .pill.warn {
                background: #fef3c7;
                color: #92400e;
            }

            /* 상세 영양정보 박스 */
            .nutrition-detail {
                background: #ffffff;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                padding: 6px 8px;
                font-size: 11px;
                color: #4b5563;
                margin-top: 4px;
            }
            .nutrition-detail table {
                width: 100%;
                border-collapse: collapse;
            }
            .nutrition-detail th,
            .nutrition-detail td {
                padding: 2px 0;
                text-align: left;
            }
            .nutrition-detail th {
                width: 55%;
                font-weight: 500;
                color: #374151;
            }

            .detail-toggle-btn {
                margin-top: 4px;
                padding: 3px 9px;
                font-size: 11px;
            }

            @media (max-width: 780px) {
                .grid {
                    grid-template-columns: minmax(0, 1fr);
                }
                .card {
                    padding: 18px 16px 18px;
                }
                .result-card {
                    grid-template-columns: 70px minmax(0, 1fr);
                }
            }
        </style>
    </head>
    <body>
        <div class="wrapper">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">음식 이미지 분류 서비스</h1>
                    <p class="card-subtitle">
                        음식 사진을 업로드하면 음식 종류와 영양·알레르기 정보를
                        보여줍니다.
                    </p>
                </div>

                <div class="grid">
                    <!-- 왼쪽: 업로드 영역 -->
                    <section>
                        <div class="upload-box">
                            <div class="upload-label">이미지 업로드</div>
                            <div id="uploadArea" class="upload-area">
                                <div class="upload-main">
                                    이미지 파일을 선택하거나 클릭하여
                                    업로드하세요.
                                </div>
                                <div class="upload-sub">
                                    JPG, PNG, JPEG · 최대 10장
                                </div>
                                <input
                                    id="fileInput"
                                    type="file"
                                    accept="image/*"
                                    multiple
                                />
                            </div>

                            <div
                                id="previewWrapper"
                                class="preview-wrapper"
                                style="display: none"
                            >
                                <img
                                    id="previewImage"
                                    class="preview-image"
                                    alt="미리보기"
                                />
                                <div
                                    id="previewInfo"
                                    class="preview-info"
                                ></div>
                            </div>

                            <div class="buttons">
                                <button
                                    id="selectBtn"
                                    class="btn-secondary"
                                    type="button"
                                >
                                    파일 선택
                                </button>
                                <button
                                    id="predictBtn"
                                    class="btn-primary"
                                    type="button"
                                    disabled
                                >
                                    분류하기
                                </button>
                            </div>

                            <div id="status" class="status"></div>
                        </div>
                    </section>

                    <!-- 오른쪽: 결과 영역 -->
                    <section>
                        <div class="upload-label" style="margin-bottom: 8px">
                            분석 결과
                        </div>
                        <div class="result-box">
                            <div id="emptyResult" class="result-empty">
                                아직 결과가 없습니다. 왼쪽에서 이미지를 업로드한
                                후 분류하기를 눌러주세요.
                            </div>

                            <div
                                id="resultsContainer"
                                class="results-container"
                            ></div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <script>
            const API_BASE = 'http://127.0.0.1:8000';

            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const selectBtn = document.getElementById('selectBtn');
            const predictBtn = document.getElementById('predictBtn');
            const statusEl = document.getElementById('status');
            const previewWrapper = document.getElementById('previewWrapper');
            const previewImage = document.getElementById('previewImage');
            const previewInfo = document.getElementById('previewInfo');

            const emptyResult = document.getElementById('emptyResult');
            const resultsContainer =
                document.getElementById('resultsContainer');

            let currentFiles = [];

            function setStatus(text, type = '') {
                statusEl.textContent = text || '';
                statusEl.className = 'status' + (type ? ' ' + type : '');
            }

            function resetResult() {
                emptyResult.style.display = 'block';
                resultsContainer.innerHTML = '';
            }

            function handleFiles(fileList) {
                if (!fileList || !fileList.length) return;

                const files = Array.from(fileList);

                if (files.length > 10) {
                    setStatus('최대 10장까지 선택할 수 있습니다.', 'error');
                    return;
                }

                const imageFiles = files.filter((f) =>
                    f.type.startsWith('image/')
                );
                if (imageFiles.length === 0) {
                    setStatus('이미지 파일만 업로드할 수 있습니다.', 'error');
                    return;
                }

                // 이전 결과/상태 초기화
                resetResult();
                setStatus('');

                currentFiles = imageFiles;
                predictBtn.disabled = false;

                // 미리보기: 첫 번째 이미지 + 개수 정보
                const first = imageFiles[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewWrapper.style.display = 'flex';
                    previewInfo.innerHTML =
                        `<div><b>선택된 파일 수</b> ${imageFiles.length}개</div>` +
                        `<div><b>대표 파일명</b> ${first.name}</div>` +
                        `<div><b>형식</b> ${first.type}</div>`;
                };
                reader.readAsDataURL(first);
            }

            uploadArea.addEventListener('click', () => fileInput.click());
            selectBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) =>
                handleFiles(e.target.files)
            );

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('hover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('hover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('hover');
                handleFiles(e.dataTransfer.files);
            });

            predictBtn.addEventListener('click', async () => {
                if (!currentFiles.length) {
                    setStatus('먼저 이미지를 선택해주세요.', 'error');
                    return;
                }

                if (currentFiles.length > 10) {
                    setStatus('최대 10장까지 선택할 수 있습니다.', 'error');
                    return;
                }

                resetResult();
                setStatus(
                    `${currentFiles.length}개 이미지를 분류 중입니다...`,
                    'success'
                );
                predictBtn.disabled = true;

                try {
                    let idx = 0;
                    for (const file of currentFiles) {
                        const formData = new FormData();
                        formData.append('file', file);

                        const res = await fetch(`${API_BASE}/predict`, {
                            method: 'POST',
                            body: formData,
                        });

                        if (!res.ok) {
                            throw new Error(`서버 오류 (${res.status})`);
                        }

                        const data = await res.json();
                        addResultCard(file, data, idx);
                        idx += 1;
                    }

                    if (idx > 0) {
                        emptyResult.style.display = 'none';
                    }

                    setStatus(
                        `${currentFiles.length}개 이미지 분류가 완료되었습니다.`,
                        'success'
                    );
                } catch (err) {
                    console.error(err);
                    setStatus('예측 중 오류가 발생했습니다.', 'error');
                } finally {
                    predictBtn.disabled = !currentFiles.length;
                }
            });

            function addResultCard(file, data, index) {
                const card = document.createElement('div');
                card.className = 'result-card';

                const imgUrl = URL.createObjectURL(file);

                card.innerHTML = `
                    <img class="result-card-thumb" src="${imgUrl}" alt="preview-${index}" />
                    <div class="result-main">
                        <div class="result-row">
                            <span class="result-label">파일</span>
                            <span style="font-size:12px;color:#6b7280;">${file.name}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">예측된 음식</span>
                            <div class="food-name">
                                <span class="food-ko"></span>
                                <span class="food-en food-name-en"></span>
                                <span class="confidence" style="display:none;">
                                    <span class="conf-dot"></span>
                                    <span class="conf-text"></span>
                                </span>
                            </div>
                        </div>
                        <div class="result-row">
                            <span class="result-label">예측 확률</span>
                            <span class="prob-text"></span>
                            <div class="prob-bar-wrap">
                                <div class="prob-bar"></div>
                            </div>
                        </div>
                        <div class="result-row">
                            <span class="result-label">영양 정보</span>
                            <div class="nutrition-basic"></div>
                            <button class="btn-secondary detail-toggle-btn" type="button" style="display:none;">
                                상세 영양정보 보기 ▾
                            </button>
                            <div class="nutrition-detail" style="display:none;"></div>
                        </div>
                        <div class="result-row">
                            <span class="result-label">알레르기 성분</span>
                            <div class="allergen-area"></div>
                        </div>
                    </div>
                `;

                resultsContainer.appendChild(card);

                const foodKoEl = card.querySelector('.food-ko');
                const foodEnEl = card.querySelector('.food-en');
                const probTextEl = card.querySelector('.prob-text');
                const probBarEl = card.querySelector('.prob-bar');
                const confBadge = card.querySelector('.confidence');
                const confDot = card.querySelector('.conf-dot');
                const confText = card.querySelector('.conf-text');
                const nutritionBasic = card.querySelector('.nutrition-basic');
                const detailBtn = card.querySelector('.detail-toggle-btn');
                const nutritionDetail = card.querySelector('.nutrition-detail');
                const allergenArea = card.querySelector('.allergen-area');

                const en = data.en_name || '-';
                const ko = data.ko_name || '-';
                const prob =
                    typeof data.probability === 'number' ? data.probability : 0;

                foodKoEl.textContent = ko;
                foodEnEl.textContent = en === '-' ? '' : `(${en})`;

                const probPercent = (prob * 100).toFixed(2);
                probTextEl.textContent = `${probPercent} %`;
                probBarEl.style.width = `${Math.max(prob * 100, 4)}%`;

                let label = '';
                let cls = 'conf-dot';
                if (prob >= 0.8) {
                    label = '확신 높음';
                    cls = 'conf-dot';
                } else if (prob >= 0.5) {
                    label = '보통 정도';
                    cls = 'conf-dot conf-mid';
                } else {
                    label = '확신 낮음';
                    cls = 'conf-dot conf-low';
                }
                confBadge.style.display = 'inline-flex';
                confText.textContent = label;
                confDot.className = cls;

                const n = data.nutrition || {};
                const unit = n.unit;

                // 기본 6개
                const basicItems = [];
                if (n.calories_kcal != null)
                    basicItems.push(`칼로리 ${n.calories_kcal} kcal`);
                if (n.carbs_g != null)
                    basicItems.push(`탄수화물 ${n.carbs_g} g`);
                if (n.protein_g != null)
                    basicItems.push(`단백질 ${n.protein_g} g`);
                if (n.fat_g != null) basicItems.push(`지방 ${n.fat_g} g`);
                if (n.sugars_g != null) basicItems.push(`당류 ${n.sugars_g} g`);
                if (n.sodium_mg != null)
                    basicItems.push(`나트륨 ${n.sodium_mg} mg`);

                if (basicItems.length > 0) {
                    const unitHtml = unit
                        ? `<div class="prob-text" style="margin-bottom:4px;">기준량: ${unit} 기준</div>`
                        : '';
                    nutritionBasic.innerHTML =
                        unitHtml +
                        '<div class="pill-group">' +
                        basicItems
                            .map((t) => `<span class="pill">${t}</span>`)
                            .join('') +
                        '</div>';
                } else {
                    nutritionBasic.innerHTML =
                        '<div class="result-empty">해당 음식의 영양 정보가 아직 등록되지 않았습니다.</div>';
                }

                // 상세 18개
                const detailFields = [
                    ['수분', n.moisture_g, 'g'],
                    ['회분', n.ash_g, 'g'],
                    ['식이섬유', n.dietary_fiber_g, 'g'],
                    ['칼슘', n.calcium_mg, 'mg'],
                    ['철', n.iron_mg, 'mg'],
                    ['인', n.phosphorus_mg, 'mg'],
                    ['칼륨', n.potassium_mg, 'mg'],
                    ['비타민 A', n.vitamin_a_ug_rae, 'μg RAE'],
                    ['레티놀', n.retinol_ug, 'μg'],
                    ['베타카로틴', n.beta_carotene_ug, 'μg'],
                    ['티아민', n.thiamin_mg, 'mg'],
                    ['리보플라빈', n.riboflavin_mg, 'mg'],
                    ['니아신', n.niacin_mg, 'mg'],
                    ['비타민 C', n.vitamin_c_mg, 'mg'],
                    ['비타민 D', n.vitamin_d_ug, 'μg'],
                    ['콜레스테롤', n.cholesterol_mg, 'mg'],
                    ['포화지방산', n.saturated_fatty_acids_g, 'g'],
                    ['트랜스지방산', n.trans_fatty_acids_g, 'g'],
                ];

                const detailRows = detailFields
                    .filter(([, value]) => value != null)
                    .map(([label, value, unit]) => {
                        return `<tr><th>${label}</th><td>${value} ${unit}</td></tr>`;
                    });

                if (detailRows.length > 0) {
                    nutritionDetail.innerHTML =
                        '<table>' + detailRows.join('') + '</table>';
                    detailBtn.style.display = 'inline-block';

                    let opened = false;
                    detailBtn.onclick = () => {
                        opened = !opened;
                        nutritionDetail.style.display = opened
                            ? 'block'
                            : 'none';
                        detailBtn.textContent = opened
                            ? '상세 영양정보 숨기기 ▴'
                            : '상세 영양정보 보기 ▾';
                    };
                } else {
                    nutritionDetail.innerHTML = '';
                    nutritionDetail.style.display = 'none';
                    detailBtn.style.display = 'none';
                }

                const allergens = data.allergens || [];
                if (allergens.length > 0) {
                    allergenArea.innerHTML =
                        '<div class="pill-group">' +
                        allergens
                            .map((a) => `<span class="pill warn">${a}</span>`)
                            .join('') +
                        '</div>';
                } else {
                    allergenArea.innerHTML =
                        '<div class="result-empty">등록된 알레르기 성분이 없습니다.</div>';
                }
            }
        </script>
    </body>
</html>
